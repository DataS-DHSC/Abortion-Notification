{% extends "layouts/main.html" %}
{% from "govuk/components/tag/macro.njk"    import govukTag    %}
{% from "govuk/components/button/macro.njk" import govukButton %}


{% block pageTitle %}Forms â€“ Abortion Notification Service{% endblock %}

{% block content %}

  {{ govukButton({
    text: "Add a new form",
    href: "/forms/new",
    classes: "govuk-!-margin-bottom-6"
  }) }}

  <form method="get" class="govuk-!-margin-bottom-6">
    <div class="govuk-form-group">
      <label class="govuk-label" for="q">Find a form</label>
      <span class="govuk-hint">Search by form ID, patient reference, clinic name or clinic number</span>
      <input class="govuk-input" id="q" name="q" type="search" value="{{ search | escape }}" autocomplete="off">
    </div>
    {{ govukButton({ text: "Search" }) }}
  </form>

  <table class="govuk-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th scope="col" class="govuk-table__header">Date created</th>
        <th scope="col" class="govuk-table__header">Form ID</th>
        <th scope="col" class="govuk-table__header">Patient reference</th>
        <th scope="col" class="govuk-table__header">Clinic</th>
        <th scope="col" class="govuk-table__header">Form status</th>
        <th scope="col" class="govuk-table__header">Actions</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
      {% for f in forms %}
        <tr class="govuk-table__row">
          <td class="govuk-table__cell">{{ f.dateCreated }}</td>
          <td class="govuk-table__cell">{{ f.formId }}</td>
          <td class="govuk-table__cell">{{ f.patientReference }}</td>
          <td class="govuk-table__cell">{{ f.clinicName }}</td>
          <td class="govuk-table__cell">
            {% if f.formStatus == 'SUBMITTED' %}
              {{ govukTag({ text: f.formStatus, classes: 'govuk-tag--green' }) }}
            {% elif f.formStatus == 'RETURNED' %}
              {{ govukTag({ text: f.formStatus, classes: 'govuk-tag--red' }) }}
            {% else %}
              {{ govukTag({ text: f.formStatus, classes: 'govuk-tag--yellow' }) }}
            {% endif %}
          </td>
          <td class="govuk-table__cell">
            <a class="govuk-link" href="/forms/{{ f.formId }}">Review</a>
            &nbsp;&nbsp;
            <a class="govuk-link" href="/forms/{{ f.formId }}/archive">Archive</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {# ---------------- Pagination (Design-System component) ---------------- #}
  {% if totalPages > 1 %}
  
    {# ---------- rebuild the query-string (everything except page) ---------- #}
    {% set qs = '' %}
    {% if search %}{% set qs = qs + '&q=' + (search | urlencode) %}{% endif %}
    {% for c in selectedClin %}{% set qs = qs + '&clinic=' + (c | urlencode) %}{% endfor %}
    {% for s in selectedStat %}{% set qs = qs + '&status=' + (s | urlencode) %}{% endfor %}
  
    {# ---------- previous / next link objects ---------- #}
    {% set prevLink = false %}
    {% if page > 1 %}
      {% set prevLink = { href: '/forms?page=' + (page - 1) + qs } %}
    {% endif %}
  
    {% set nextLink = false %}
    {% if page < totalPages %}
      {% set nextLink = { href: '/forms?page=' + (page + 1) + qs } %}
    {% endif %}
  
    {# ---------- items array (choose the layout, then call macro) ---------- #}
    {% if totalPages > 3 %}
      {% set items = [
        { number: 1,          current: (page == 1),          href: '/forms?page=1' + qs },
        { number: 2,          current: (page == 2),          href: '/forms?page=2' + qs },
        { ellipsis: true },
        { number: totalPages, current: (page == totalPages), href: '/forms?page=' + totalPages + qs }
      ] %}
    {% else %}
      {% set items = [
        { number: 1, current: (page == 1), href: '/forms?page=1' + qs },
        { number: 2, current: (page == 2), href: '/forms?page=2' + qs }
      ] %}
    {% endif %}
  
    {{ govukPagination({
      previous: prevLink,
      next: nextLink,
      items: items
    }) }}
  
  {% endif %}
  

   

{% endblock %}
